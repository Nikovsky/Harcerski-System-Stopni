name: ${STACK_NAME:-hss}

services:
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:18-alpine}
    container_name: ${POSTGRES_CONTAINER_NAME:-hss_postgres}
    hostname: ${POSTGRES_CONTAINER_NAME:-hss_postgres}
    restart: unless-stopped
    init: true
    stop_grace_period: 60s

    environment:
      POSTGRES_USER: ${POSTGRES_USER:-hss}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set in docker/.env}
      POSTGRES_DB: ${POSTGRES_DATABASE:-hss}
      POSTGRES_INITDB_ARGS: "${POSTGRES_INITDB_ARGS:---data-checksums}"

      TZ: ${TZ:-Europe/Warsaw}
      KC_DB_NAME: ${KEYCLOAK_POSTGRES_DATABASE:-keycloak}
      KC_DB_USER: ${KEYCLOAK_POSTGRES_USER:-keycloak}
      KC_DB_PASSWORD: ${KEYCLOAK_POSTGRES_PASSWORD:?set in docker/.env}

    ports:
      - "127.0.0.1:${POSTGRES_PORT:-5432}:5432"

    volumes:
      - pg_data:/var/lib/postgresql
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./postgres/conf.d:/etc/postgresql/conf.d:ro

    shm_size: ${POSTGRES_SHM_SIZE:-1gb}
    ulimits:
      nofile: 1048576

    mem_limit: ${POSTGRES_MEM_LIMIT:-2g}
    cpus: ${POSTGRES_CPUS:-2.0}

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: ${POSTGRES_LOG_MAX_SIZE:-10m}
        max-file: ${POSTGRES_LOG_MAX_FILE:-3}

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB -h 127.0.0.1 || exit 1" ]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s

    command: >
      postgres -c config_file=/etc/postgresql/postgresql.conf

    networks:
      - infra

  keycloak:
    image: ${KEYCLOAK_IMAGE:-quay.io/keycloak/keycloak:26.4.7}
    container_name: ${KEYCLOAK_CONTAINER_NAME:-hss_keycloak}
    hostname: ${KEYCLOAK_CONTAINER_NAME:-hss_keycloak}
    restart: unless-stopped
    init: true
    stop_grace_period: 60s

    mem_limit: ${KEYCLOAK_MEM_LIMIT:-1g}
    cpus: ${KEYCLOAK_CPUS:-2.0}

    depends_on:
      postgres:
        condition: service_healthy

    expose:
      - "${KEYCLOAK_HTTP_PORT:-8080}"
      - "${KEYCLOAK_MGMT_PORT:-9000}"

    environment:
      TZ: ${TZ:-Europe/Warsaw}

      # Bootstrap admin
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN:?set in docker/.env}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:?set in docker/.env}

      # Client secrets (for import)
      KEYCLOAK_HSS_WEB_CLIENT_SECRET: ${KEYCLOAK_HSS_WEB_CLIENT_SECRET:?set in docker/.env}
      KEYCLOAK_HSS_API_CLIENT_SECRET: ${KEYCLOAK_HSS_API_CLIENT_SECRET:?set in docker/.env}

      # DB
      KC_DB: ${KEYCLOAK_DATABASE:-postgres}
      KC_DB_URL_HOST: ${KEYCLOAK_DATABASE_URL_HOST:-postgres}
      KC_DB_URL_PORT: ${KEYCLOAK_DATABASE_URL_PORT:-5432}
      KC_DB_URL_DATABASE: ${KEYCLOAK_POSTGRES_DATABASE:-keycloak}
      KC_DB_USERNAME: ${KEYCLOAK_POSTGRES_USER:-keycloak}
      KC_DB_PASSWORD: ${KEYCLOAK_POSTGRES_PASSWORD:?set in docker/.env}

      # Reverse proxy
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: ${KEYCLOAK_HTTP_PORT:-8080}
      KC_PROXY_HEADERS: ${KEYCLOAK_PROXY_HEADERS:-xforwarded}
      # KC_PROXY_TRUSTED_ADDRESSES: ${KC_PROXY_TRUSTED_ADDRESSES:-172.16.0.0/12}

      # Public/admin URLs (bezpieczne redirecty + issuer)
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-https://auth.hss.local}
      KC_HOSTNAME_STRICT: "${KEYCLOAK_HOSTNAME_STRICT:-true}"
      KC_HOSTNAME_DEBUG: "${KEYCLOAK_HOSTNAME_DEBUG:-false}"
      KC_HOSTNAME_ADMIN: ${KEYCLOAK_HOSTNAME_ADMIN:-https://authconsole.hss.local}

      # Health/Management interface
      KC_HEALTH_ENABLED: "true"
      KC_HTTP_MANAGEMENT_PORT: ${KEYCLOAK_MGMT_PORT:-8081}
      KC_HTTP_MANAGEMENT_HEALTH_ENABLED: "true"

    # Hardening
    read_only: true

    volumes:
      - keycloak_quarkus:/opt/keycloak/lib/quarkus
      - ./keycloak:/opt/keycloak/data/import:ro
      - ./keycloak/themes/hss:/opt/keycloak/themes/hss:ro

    tmpfs:
      - /tmp:rw,noexec,nosuid,size=256m,mode=1777
      - /opt/keycloak/data/tmp:rw,noexec,nosuid,size=256m,mode=1777
      - /opt/keycloak/data/transaction-logs:rw,noexec,nosuid,size=64m,mode=1777

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    command: [ "start", "--import-realm" ] # start-dev -> start :contentReference[oaicite:4]{index=4}

    healthcheck:
      test: [ "CMD-SHELL", "bash -ec 'exec 3<>/dev/tcp/127.0.0.1/${KEYCLOAK_MGMT_PORT:-8081}; printf \"GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n\" >&3; head -n 1 <&3 | grep -q \"200\"'" ]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 40s

    networks:
      - infra

  minio:
    image: ${MINIO_IMAGE:-minio/minio:RELEASE.2025-09-07T16-13-09Z}
    container_name: ${MINIO_CONTAINER_NAME:-hss_minio}
    hostname: ${MINIO_CONTAINER_NAME:-hss_minio}
    restart: unless-stopped
    init: true
    stop_grace_period: 30s

    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:?set in infra/docker/compose/.env}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:?set in infra/docker/compose/.env}
      MINIO_REGION: ${MINIO_REGION:-eu-central-1}
      TZ: ${TZ:-Europe/Warsaw}
      # MINIO_SERVER_URL: ${MINIO_SERVER_URL:-https://s3.hss.local}
      MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL:-https://s3console.hss.local}
      MINIO_API_CORS_ALLOW_ORIGIN: "https://s3console.hss.local,https://hss.local,https://api.hss.local,https://s3.hss.local"

    command: [ "server", "/data", "--address", ":9000", "--console-address", ":9001" ]

    ports:
      - "127.0.0.1:${MINIO_PORT:-9000}:9000"
      - "127.0.0.1:${MINIO_CONSOLE_PORT:-9001}:9001"

    volumes:
      - minio_data:/data

    # Tight limits (256MB). Console may be heavy at this level.
    mem_limit: ${MINIO_MEM_LIMIT:-256m}
    cpus: ${MINIO_CPUS:-1.0}

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    ulimits:
      nofile: 65536

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

    networks:
      - infra

  nginx:
    image: ${NGINX_IMAGE:-nginx:1.29.4-alpine-slim}
    container_name: ${NGINX_CONTAINER_NAME:-hss_nginx}
    hostname: ${NGINX_CONTAINER_NAME:-hss_nginx}
    restart: unless-stopped
    init: true
    stop_grace_period: 30s

    mem_limit: ${NGINX_MEM_LIMIT:-256m}
    cpus: ${NGINX_CPUS:-1.0}

    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      minio:
        condition: service_started

    ports:
      - "127.0.0.1:${NGINX_HTTP_PORT:-80}:80"
      - "127.0.0.1:${NGINX_HTTPS_PORT:-443}:443"

    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/502.html:/usr/share/nginx/html/502.html:ro
      - ./nginx/502-bg.webp:/usr/share/nginx/html/502-bg.webp:ro
      - ${CERTS_DIR:-./certs}/${TLS_CERT_PEM:-hss.local.pem}:/etc/nginx/certs/hss.local.pem:ro
      - ${CERTS_DIR:-./certs}/${TLS_CERT_KEY:-hss.local-key.pem}:/etc/nginx/certs/hss.local-key.pem:ro

    extra_hosts:
      - "host.docker.internal:host-gateway"

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE

    read_only: true
    tmpfs:
      - /var/run:rw,noexec,nosuid,size=16m
      - /var/cache/nginx:rw,noexec,nosuid,size=128m
      - /var/log/nginx:rw,noexec,nosuid,size=32m

    networks:
      - infra

    healthcheck:
      test: [ "CMD-SHELL", "nginx -t || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  pg_data:
  minio_data:
  keycloak_quarkus:


networks:
  infra:
    driver: bridge
