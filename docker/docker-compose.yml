name: ${STACK_NAME:-hss}

services:
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:18-alpine}
    container_name: ${POSTGRES_CONTAINER_NAME:-hss_postgres}
    hostname: ${POSTGRES_CONTAINER_NAME:-hss_postgres}
    restart: unless-stopped
    init: true
    stop_grace_period: 60s

    environment:
      POSTGRES_USER: ${POSTGRES_USER:-hss}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set in docker/.env}
      POSTGRES_DB: ${POSTGRES_DATABASE:-hss}
      POSTGRES_INITDB_ARGS: "${POSTGRES_INITDB_ARGS:---data-checksums}"

      TZ: ${TZ:-Europe/Warsaw}
      KC_DB_NAME: ${KEYCLOAK_POSTGRES_DATABASE:-keycloak}
      KC_DB_USER: ${KEYCLOAK_POSTGRES_USER:-keycloak}
      KC_DB_PASSWORD: ${KEYCLOAK_POSTGRES_PASSWORD:?set in docker/.env}

    ports:
      - "127.0.0.1:${POSTGRES_PORT:-5432}:5432"

    volumes:
      - pg_data:/var/lib/postgresql
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./postgres/conf.d:/etc/postgresql/conf.d:ro

    shm_size: ${POSTGRES_SHM_SIZE:-1gb}
    ulimits:
      nofile: 1048576

    mem_limit: ${POSTGRES_MEM_LIMIT:-2g}
    cpus: ${POSTGRES_CPUS:-2.0}

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: ${POSTGRES_LOG_MAX_SIZE:-10m}
        max-file: ${POSTGRES_LOG_MAX_FILE:-3}

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB -h 127.0.0.1 || exit 1" ]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s

    command: >
      postgres -c config_file=/etc/postgresql/postgresql.conf

    networks:
      - infra

  keycloak:
    image: ${KEYCLOAK_IMAGE:-quay.io/keycloak/keycloak:26.4.7}
    container_name: ${KEYCLOAK_CONTAINER_NAME:-hss_keycloak}
    hostname: ${KEYCLOAK_CONTAINER_NAME:-hss_keycloak}
    restart: unless-stopped
    init: true
    stop_grace_period: 60s

    mem_limit: ${KEYCLOAK_MEM_LIMIT:-1g}
    cpus: ${KEYCLOAK_CPUS:-2.0}

    depends_on:
      postgres:
        condition: service_healthy

    expose:
      - "${KEYCLOAK_HTTP_PORT:-8080}"
      - "${KEYCLOAK_MGMT_PORT:-9000}"

    environment:
      TZ: ${TZ:-Europe/Warsaw}

      # Bootstrap admin
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN:?set in docker/.env}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:?set in docker/.env}

      # Client secrets (for import)
      KEYCLOAK_HSS_WEB_CLIENT_SECRET: ${KEYCLOAK_HSS_WEB_CLIENT_SECRET:?set in docker/.env}
      KEYCLOAK_HSS_API_CLIENT_SECRET: ${KEYCLOAK_HSS_API_CLIENT_SECRET:?set in docker/.env}
      KEYCLOAK_PASSWORD_REGEX: ${KEYCLOAK_PASSWORD_REGEX:?set in docker/.env}

      # DB
      KC_DB: ${KEYCLOAK_DATABASE:-postgres}
      KC_DB_URL_HOST: ${KEYCLOAK_DATABASE_URL_HOST:-postgres}
      KC_DB_URL_PORT: ${KEYCLOAK_DATABASE_URL_PORT:-5432}
      KC_DB_URL_DATABASE: ${KEYCLOAK_POSTGRES_DATABASE:-keycloak}
      KC_DB_USERNAME: ${KEYCLOAK_POSTGRES_USER:-keycloak}
      KC_DB_PASSWORD: ${KEYCLOAK_POSTGRES_PASSWORD:?set in docker/.env}

      # Reverse proxy
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: ${KEYCLOAK_HTTP_PORT:-8080}
      KC_PROXY_HEADERS: ${KEYCLOAK_PROXY_HEADERS:-xforwarded}
      # KC_PROXY_TRUSTED_ADDRESSES: ${KC_PROXY_TRUSTED_ADDRESSES:-172.16.0.0/12}

      # Public/admin URLs (bezpieczne redirecty + issuer)
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-https://auth.hss.local}
      KC_HOSTNAME_STRICT: "${KEYCLOAK_HOSTNAME_STRICT:-true}"
      KC_HOSTNAME_DEBUG: "${KEYCLOAK_HOSTNAME_DEBUG:-false}"
      KC_HOSTNAME_ADMIN: ${KEYCLOAK_HOSTNAME_ADMIN:-https://authconsole.hss.local}

      # Health/Management interface
      KC_HEALTH_ENABLED: "true"
      KC_HTTP_MANAGEMENT_PORT: ${KEYCLOAK_MGMT_PORT:-8081}
      KC_HTTP_MANAGEMENT_HEALTH_ENABLED: "true"

    # Hardening
    read_only: true

    volumes:
      - keycloak_quarkus:/opt/keycloak/lib/quarkus
      - ./keycloak:/opt/keycloak/data/import:ro
      - ./keycloak/themes/hss:/opt/keycloak/themes/hss/login:ro

    tmpfs:
      - /tmp:rw,noexec,nosuid,size=256m,mode=1777
      - /opt/keycloak/data/tmp:rw,noexec,nosuid,size=256m,mode=1777
      - /opt/keycloak/data/transaction-logs:rw,noexec,nosuid,size=64m,mode=1777

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    command: [ "start", "--import-realm" ] # start-dev -> start :contentReference[oaicite:4]{index=4}

    healthcheck:
      test: [ "CMD-SHELL", "bash -ec 'exec 3<>/dev/tcp/127.0.0.1/${KEYCLOAK_MGMT_PORT:-8081}; printf \"GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n\" >&3; head -n 1 <&3 | grep -q \"200\"'" ]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 40s

    networks:
      - infra

  minio:
    image: ${MINIO_IMAGE:-minio/minio:RELEASE.2025-09-07T16-13-09Z}
    container_name: ${MINIO_CONTAINER_NAME:-hss_minio}
    hostname: ${MINIO_CONTAINER_NAME:-hss_minio}
    restart: unless-stopped
    init: true
    stop_grace_period: 30s

    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:?set in infra/docker/compose/.env}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:?set in infra/docker/compose/.env}
      MINIO_REGION: ${MINIO_REGION:-eu-central-1}
      TZ: ${TZ:-Europe/Warsaw}
      # MINIO_SERVER_URL: ${MINIO_SERVER_URL:-http://minio:9000}
      MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL:-http://localhost:9001}
      MINIO_API_CORS_ALLOW_ORIGIN: "https://s3console.hss.local,https://hss.local,https://api.hss.local,https://s3.hss.local"

    command: [ "server", "/data", "--address", ":9000", "--console-address", ":9001" ]

    ports:
      - "127.0.0.1:${MINIO_PORT:-9000}:9000"
      - "127.0.0.1:${MINIO_CONSOLE_PORT:-9001}:9001"

    volumes:
      - minio_data:/data

    # Tight limits (256MB). Console may be heavy at this level.
    mem_limit: ${MINIO_MEM_LIMIT:-256m}
    cpus: ${MINIO_CPUS:-1.0}

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    ulimits:
      nofile: 65536

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

    networks:
      - infra

  minio-init:
    image: ${MINIO_MC_IMAGE:-minio/mc:latest}
    container_name: ${MINIO_INIT_CONTAINER_NAME:-hss_minio_init}
    restart: "no"
    init: true

    depends_on:
      minio:
        condition: service_healthy

    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:?set in docker/.env}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:?set in docker/.env}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:?set in docker/.env}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:?set in docker/.env}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-hssbucket}

    entrypoint:
      - /bin/sh
      - -ec

    command:
      - |
        until mc alias set local http://minio:9000 "${MINIO_ROOT_USER}" "${MINIO_ROOT_PASSWORD}"; do
          sleep 1
        done

        mc mb --ignore-existing "local/${MINIO_BUCKET_NAME}"

        cat > /tmp/hss-api-bucket-policy.json <<EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "s3:ListBucket",
                "s3:GetBucketLocation"
              ],
              "Resource": ["arn:aws:s3:::${MINIO_BUCKET_NAME}"]
            },
            {
              "Effect": "Allow",
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts"
              ],
              "Resource": ["arn:aws:s3:::${MINIO_BUCKET_NAME}/*"]
            }
          ]
        }
        EOF

        mc admin policy create local hss-api-bucket-policy /tmp/hss-api-bucket-policy.json || true
        mc admin user add local "${MINIO_ACCESS_KEY}" "${MINIO_SECRET_KEY}" || true
        mc admin policy attach local hss-api-bucket-policy --user "${MINIO_ACCESS_KEY}"
        mc anonymous set none "local/${MINIO_BUCKET_NAME}"

    networks:
      - infra

  redis:
    image: ${REDIS_IMAGE:-redis:8.2.5}
    container_name: ${REDIS_CONTAINER_NAME:-hss_redis}
    hostname: ${REDIS_CONTAINER_NAME:-hss_redis}
    user: "redis:redis"
    restart: unless-stopped
    init: true
    stop_grace_period: 30s

    command:
      - /bin/sh
      - -ec
      - >
        printf '%s\n' "user default off"
        "user ${REDIS_USER:-root} on >${REDIS_PASSWORD:?set in docker/.env} ~* +@all"
        "user ${REDIS_BFF_USER:-nextbff} on >${REDIS_BFF_PASSWORD:?set in docker/.env} ~hss:sess:* ~hss:rl:* +get +set +del +eval +ping +incr +pexpire +pttl" > /tmp/users.acl
        && exec redis-server
        --bind 0.0.0.0
        --port 6379
        --appendonly ${REDIS_APPENDONLY:-yes}
        --maxmemory ${REDIS_MAXMEMORY:-256mb}
        --maxmemory-policy ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}
        --aclfile /tmp/users.acl
        --save 60 1000

    ports:
      - "127.0.0.1:${REDIS_PORT:-6379}:6379"

    volumes:
      - redis_data:/data

    mem_limit: ${REDIS_MEM_LIMIT:-512m}
    cpus: ${REDIS_CPUS:-1.0}

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    healthcheck:
      test: [ "CMD-SHELL", "redis-cli --user ${REDIS_USER:-root} --pass ${REDIS_PASSWORD:?set in docker/.env} -h 127.0.0.1 -p 6379 PING | grep -q PONG" ]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s

    networks:
      - infra

  nginx:
    image: ${NGINX_IMAGE:-nginx:1.29.4-alpine-slim}
    container_name: ${NGINX_CONTAINER_NAME:-hss_nginx}
    hostname: ${NGINX_CONTAINER_NAME:-hss_nginx}
    restart: unless-stopped
    init: true
    stop_grace_period: 30s

    mem_limit: ${NGINX_MEM_LIMIT:-256m}
    cpus: ${NGINX_CPUS:-1.0}

    environment:
      NGINX_RL_API_RATE: ${NGINX_RL_API_RATE:-10000r/s}
      NGINX_RL_API_BURST: ${NGINX_RL_API_BURST:-10000}
      NGINX_RL_AUTH_RATE: ${NGINX_RL_AUTH_RATE:-10000r/s}
      NGINX_RL_AUTH_BURST: ${NGINX_RL_AUTH_BURST:-10000}

    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      minio:
        condition: service_started

    ports:
      - "127.0.0.1:${NGINX_HTTP_PORT:-80}:80"
      - "127.0.0.1:${NGINX_HTTPS_PORT:-443}:443"

    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/templates/default.conf.template:ro
      - ./nginx/502.html:/usr/share/nginx/html/502.html:ro
      - ./nginx/502-bg.webp:/usr/share/nginx/html/502-bg.webp:ro
      - ${CERTS_DIR:-./certs}/${TLS_CERT_PEM:-hss.local.pem}:/etc/nginx/certs/hss.local.pem:ro
      - ${CERTS_DIR:-./certs}/${TLS_CERT_KEY:-hss.local-key.pem}:/etc/nginx/certs/hss.local-key.pem:ro

    extra_hosts:
      - "host.docker.internal:host-gateway"

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE

    read_only: true
    tmpfs:
      - /etc/nginx/conf.d:rw,noexec,nosuid,size=2m
      - /var/run:rw,noexec,nosuid,size=16m
      - /var/cache/nginx:rw,noexec,nosuid,size=128m
      - /var/log/nginx:rw,noexec,nosuid,size=32m

    networks:
      - infra

    healthcheck:
      test: [ "CMD-SHELL", "nginx -t || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  pg_data:
  minio_data:
  keycloak_quarkus:
  redis_data:


networks:
  infra:
    driver: bridge
