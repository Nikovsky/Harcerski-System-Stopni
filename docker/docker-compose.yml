name: ${STACK_NAME:-hss}

services:
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:18-alpine}
    container_name: ${POSTGRES_CONTAINER_NAME:-hss_postgres}
    hostname: ${POSTGRES_CONTAINER_NAME:-hss_postgres}
    restart: unless-stopped
    init: true
    stop_grace_period: 60s

    environment:
      # Main application DB
      POSTGRES_USER: ${PG_USER:-hss}
      POSTGRES_PASSWORD: ${PG_PASSWORD:?set in infra/docker/.env}
      POSTGRES_DB: ${PG_DB:-hss}

      TZ: ${TZ:-Europe/Warsaw}
      POSTGRES_INITDB_ARGS: "${PG_INITDB_ARGS:---data-checksums}"
      KC_DB_NAME: ${KC_PG_DB:-keycloak}
      KC_DB_USER: ${KC_PG_USER:-keycloak}
      KC_DB_PASSWORD: ${KC_PG_PASSWORD:?set in infra/docker/.env}

    ports:
      - "127.0.0.1:${PG_PORT:-5432}:5432"

    volumes:
      - pg_data:/var/lib/postgresql
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./postgres/conf.d:/etc/postgresql/conf.d:ro

    shm_size: ${PG_SHM_SIZE:-1gb}

    ulimits:
      nofile: 1048576

    mem_limit: ${PG_MEM_LIMIT:-2g}
    cpus: ${PG_CPUS:-2.0}

    security_opt:
      - no-new-privileges:true

    logging:
      driver: json-file
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILE:-3}

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB -h 127.0.0.1 || exit 1" ]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s

    command: >
      postgres -c config_file=/etc/postgresql/postgresql.conf

    networks:
      - infra

  keycloak:
    image: ${KEYCLOAK_IMAGE:-quay.io/keycloak/keycloak:26.4.7}
    container_name: ${KEYCLOAK_CONTAINER_NAME:-hss_keycloak}
    hostname: ${KEYCLOAK_CONTAINER_NAME:-hss_keycloak}
    restart: unless-stopped
    init: true
    stop_grace_period: 60s

    mem_limit: ${KEYCLOAK_MEM_LIMIT:-1g}
    cpus: ${KEYCLOAK_CPUS:-2.0}

    depends_on:
      postgres:
        condition: service_healthy

    environment:
      TZ: ${TZ:-Europe/Warsaw}

      # Bootstrap admin
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN:?set in infra/docker/compose/.env}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:?set in infra/docker/compose/.env}
      KEYCLOAK_hss_WEB_CLIENT_SECRET: ${KEYCLOAK_hss_WEB_CLIENT_SECRET:?set in infra/docker/compose/.env}

      # DB
      KC_DB: postgres
      KC_DB_URL_HOST: postgres
      KC_DB_URL_PORT: 5432
      KC_DB_URL_DATABASE: ${KC_PG_DB:-keycloak}
      KC_DB_USERNAME: ${KC_PG_USER:-keycloak}
      KC_DB_PASSWORD: ${KC_PG_PASSWORD:?set in infra/docker/compose/.env}

      # Reverse proxy (TLS terminates at nginx => http to Keycloak is OK)
      KC_HTTP_ENABLED: "true"
      KC_PROXY_HEADERS: "xforwarded"

      # Public URL of Keycloak (what users see)
      KC_HOSTNAME: "https://auth.hss.local"
      KC_HOSTNAME_STRICT: "true"
      KC_HTTP_RELATIVE_PATH: "/"

      # Optional hardening: trust proxy headers only from nginx/docker subnet
      # KC_PROXY_TRUSTED_ADDRESSES: ${KC_PROXY_TRUSTED_ADDRESSES:-172.16.0.0/12}

      # Management / health
      KC_HEALTH_ENABLED: "true"
      KC_HTTP_MANAGEMENT_PORT: 9100
      KC_HTTP_MANAGEMENT_RELATIVE_PATH: /

    volumes:
      - ./keycloak:/opt/keycloak/data/import:ro

    command: [ "start-dev", "--import-realm", "--http-port=8080" ]
    ports:
      - "127.0.0.1:${KEYCLOAK_PORT:-8080}:8080"
      - "127.0.0.1:${KEYCLOAK_MGMT_PORT:-9100}:9100"

    healthcheck:
      test: [ "CMD-SHELL", "bash -ec 'exec 3<>/dev/tcp/127.0.0.1/9100; printf \"GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n\" >&3; head -n 1 <&3 | grep -q \"200\"'" ]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 40s

    networks:
      - infra

  # redis:
  #   image: ${REDIS_IMAGE:-redis:8.4.0-alpine}
  #   container_name: ${REDIS_CONTAINER_NAME:-hss_redis}
  #   hostname: ${REDIS_CONTAINER_NAME:-hss_redis}
  #   restart: unless-stopped
  #   init: true
  #   stop_grace_period: 30s

  #   ports:
  #     - "127.0.0.1:${REDIS_PORT:-6379}:6379"

  #   environment:
  #     TZ: ${TZ:-Europe/Warsaw}
  #     REDIS_PASSWORD: ${REDIS_PASSWORD:?set in infra/docker/compose/.env}

  #     # Optional overrides (nice to keep in env)
  #     REDIS_MAXMEMORY: ${REDIS_MAXMEMORY:-200mb}
  #     REDIS_MAXMEMORY_POLICY: ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}
  #     REDIS_APPENDONLY: ${REDIS_APPENDONLY:-yes}
  #     REDIS_APPENDFSYNC: ${REDIS_APPENDFSYNC:-everysec}
  #     REDIS_SAVE: ${REDIS_SAVE:-""}
  #     REDIS_DATA_DIR: /data

  #   command: [ "sh", "-c", "/usr/local/bin/run-redis.sh" ]

  #   volumes:
  #     - redis_data:/data
  #     - ./redis/run-redis.sh:/usr/local/bin/run-redis.sh:ro

  #   ulimits:
  #     nofile: 262144

  #   mem_limit: ${REDIS_MEM_LIMIT:-256m}
  #   cpus: ${REDIS_CPUS:-1.0}

  #   healthcheck:
  #     test: [ "CMD-SHELL", "redis-cli --no-auth-warning -h 127.0.0.1 -p 6379 -a $$REDIS_PASSWORD ping | grep -q PONG || exit 1" ]
  #     interval: 10s
  #     timeout: 3s
  #     retries: 10
  #     start_period: 10s

  #   networks:
  #     - infra

  minio:
    image: ${MINIO_IMAGE:-minio/minio:RELEASE.2025-09-07T16-13-09Z}
    container_name: ${MINIO_CONTAINER_NAME:-hss_minio}
    hostname: ${MINIO_CONTAINER_NAME:-hss_minio}
    restart: unless-stopped
    init: true
    stop_grace_period: 30s

    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:?set in infra/docker/compose/.env}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:?set in infra/docker/compose/.env}
      MINIO_REGION: ${MINIO_REGION:-eu-central-1}
      TZ: ${TZ:-Europe/Warsaw}
      # MINIO_SERVER_URL: ${MINIO_SERVER_URL:-http://minio:9000}
      MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL:-http://localhost:9001}
      MINIO_API_CORS_ALLOW_ORIGIN: "https://s3console.hss.local,https://hss.local,https://api.hss.local,https://s3.hss.local"

    command: [ "server", "/data", "--address", ":9000", "--console-address", ":9001" ]

    ports:
      - "127.0.0.1:${MINIO_PORT:-9000}:9000"
      - "127.0.0.1:${MINIO_CONSOLE_PORT:-9001}:9001"

    volumes:
      - minio_data:/data

    # Tight limits (256MB). Console may be heavy at this level.
    mem_limit: ${MINIO_MEM_LIMIT:-256m}
    cpus: ${MINIO_CPUS:-1.0}

    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    ulimits:
      nofile: 65536

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

    networks:
      - infra

  nginx:
    image: ${NGINX_IMAGE:-nginx:1.29.4-alpine-slim}
    container_name: ${NGINX_CONTAINER_NAME:-hss_nginx}
    hostname: ${NGINX_CONTAINER_NAME:-hss_nginx}
    restart: unless-stopped
    init: true
    stop_grace_period: 30s

    mem_limit: ${NGINX_MEM_LIMIT:-256m}
    cpus: ${NGINX_CPUS:-1.0}

    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      # redis:
      #   condition: service_healthy
      minio:
        condition: service_started

    ports:
      - "127.0.0.1:${NGINX_HTTP_PORT:-80}:80"
      - "127.0.0.1:${NGINX_HTTPS_PORT:-443}:443"

    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs/hss.local.pem:/etc/nginx/certs/hss.local.pem:ro
      - ./certs/hss.local-key.pem:/etc/nginx/certs/hss.local-key.pem:ro

    extra_hosts:
      - "host.docker.internal:host-gateway"

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE

    read_only: true
    tmpfs:
      - /var/run:rw,noexec,nosuid,size=16m
      - /var/cache/nginx:rw,noexec,nosuid,size=128m
      - /var/log/nginx:rw,noexec,nosuid,size=32m

    networks:
      - infra

    healthcheck:
      test: [ "CMD-SHELL", "nginx -t || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  pg_data:
  minio_data:


networks:
  infra:
    driver: bridge
