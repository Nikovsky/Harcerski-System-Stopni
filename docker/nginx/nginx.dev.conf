# // @file: infra/docker/compose/nginx/nginx.dev.conf

resolver 127.0.0.11 ipv6=off valid=10s;

#===[GLOBAL HARDENING]==============================================================================
server_tokens off;

map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

#===[LOGGING -> DOCKER CONSOLE]=====================================================================
log_format hss escape=json
  '{'
    '"time":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"host":"$host",'
    '"method":"$request_method",'
    '"uri":"$request_uri",'
    '"proto":"$server_protocol",'
    '"status":$status,'
    '"request_length":$request_length,'
    '"content_length":"$http_content_length",'
    '"bytes_sent":$bytes_sent,'
    '"body_bytes_sent":$body_bytes_sent,'
    '"request_time":$request_time,'
    '"upstream_addr":"$upstream_addr",'
    '"upstream_status":"$upstream_status",'
    '"upstream_response_time":"$upstream_response_time"'
  '}';

access_log /dev/stdout hss;
error_log  /dev/stderr warn;

#===[RATE LIMITS (DEV-SAFE DEFAULTS)]===============================================================
# NOTE: directives below live in http{} context (conf.d/*.conf is usually included there)
# limit_req_zone $binary_remote_addr zone=rl_api:10m  rate=20r/s;
# limit_req_zone $binary_remote_addr zone=rl_auth:10m rate=5r/s;

#===[UPSTREAMS]=====================================================================================
upstream next_dev       { server host.docker.internal:3000; }
upstream nest_dev       { server host.docker.internal:5000; }
upstream keycloak_http  { server keycloak:8080; }
upstream minio_api      { server minio:9000; }
upstream minio_console  { server minio:9001; }

#===[COMMON PROXY DEFAULTS]=========================================================================
proxy_http_version 1.1;
proxy_read_timeout 300s;
proxy_send_timeout 300s;

large_client_header_buffers 4 16k;

proxy_buffering off;
proxy_request_buffering off;

proxy_set_header Host              $host;
proxy_set_header X-Real-IP         $remote_addr;
proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Forwarded-Host  $host;
proxy_set_header X-Forwarded-Port  $server_port;

#===[HTTP->HTTPS]===================================================================================
server {
  listen 80;
  server_name
    hss.local
    api.hss.local
    auth.hss.local
    authconsole.hss.local
    s3.hss.local
    s3console.hss.local
    localhost 127.0.0.1 [::1];

  return 308 https://$host$request_uri;
}

#===[MAIN HTTPS (NEXT: hss.local)]==================================================================
server {
  listen 443 ssl;
  http2 on;

  server_name hss.local localhost 127.0.0.1 [::1];

  ssl_certificate     /etc/nginx/certs/hss.local.pem;
  ssl_certificate_key /etc/nginx/certs/hss.local-key.pem;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;
  ssl_session_tickets off;

  # ---[SECURITY HEADERS | UI]----------------------------------------------------------------------
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  client_max_body_size 0;

  ###---[BLOCK DOTFILES]----------------------------------------------------------------------------
  location ~ /\.(?!well-known) {
    return 404;
  }

  ###---[Health (no upstream)]----------------------------------------------------------------------
  location = /health {
    default_type application/json;
    add_header Content-Type application/json always;
    return 200 '{"status":"ok","service":"nginx","site":"hss.local"}';
  }

  ###---[Next.js HMR (DEV websocket)]---------------------------------------------------------------
  location /_next/webpack-hmr {
    proxy_pass http://next_dev/_next/webpack-hmr;
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }

  ###---[SHORTCUTS -> SUBDOMAINS (DEV ERGONOMICS)]--------------------------------------------------
  # location ^~ /server/     { return 308 https://api.hss.local$request_uri; }
  # location = /server       { return 308 https://api.hss.local/; }

  # location ^~ /auth/       { return 308 https://auth.hss.local$request_uri; }
  # location = /auth         { return 308 https://auth.hss.local/; }

  # location ^~ /s3/         { return 308 https://s3.hss.local$request_uri; }
  # location = /s3           { return 308 https://s3.hss.local/; }

  # location ^~ /s3console/  { return 308 https://s3console.hss.local$request_uri; }
  # location = /s3console    { return 308 https://s3console.hss.local/; }

  ###---[NEXT.JS (default /)]-----------------------------------------------------------------------
  location / {
    proxy_pass http://next_dev/;
    proxy_buffer_size 16k;
    proxy_buffers 8 16k;
    proxy_busy_buffers_size 24k;
  }
}

#===[API HTTPS (NEST: api.hss.local)]===============================================================
server {
  listen 443 ssl;
  http2 on;

  server_name api.hss.local;

  ssl_certificate     /etc/nginx/certs/hss.local.pem;
  ssl_certificate_key /etc/nginx/certs/hss.local-key.pem;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;
  ssl_session_tickets off;

  # ---[SECURITY HEADERS | API]---------------------------------------------------------------------
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  client_max_body_size 10m;

  ###---[BLOCK DOTFILES]----------------------------------------------------------------------------
  location ~ /\.(?!well-known) {
    return 404;
  }

  ###---[Health (no upstream)]----------------------------------------------------------------------
  location = /health {
    default_type application/json;
    add_header Content-Type application/json always;
    return 200 '{"status":"ok","service":"nginx","site":"api.hss.local"}';
  }

  ###---[RATE LIMIT (GLOBAL API)]-------------------------------------------------------------------
  # NOTE: adjust for your dev load; in prod usually per-endpoint buckets
  # limit_req zone=rl_api burst=60 nodelay;

  ###---[API -> NEST]-------------------------------------------------------------------------------
  location / {
    proxy_pass http://nest_dev/;

    # keep Authorization header intact (default), explicit for clarity
    proxy_set_header Authorization $http_authorization;

    # if Nest uses ws/sse anywhere (safe default)
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }
}
#===[AUTH HTTPS (KEYCLOAK: auth.hss.local)]=========================================================
server {
  listen 443 ssl;
  http2 on;

  server_name auth.hss.local;

  ssl_certificate     /etc/nginx/certs/hss.local.pem;
  ssl_certificate_key /etc/nginx/certs/hss.local-key.pem;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;
  ssl_session_tickets off;

  # ---[SECURITY HEADERS | AUTH]--------------------------------------------------------------------
  # IMPORTANT:
  # Do NOT force X-Frame-Options / frame-ancestors here.
  # OIDC session-check uses iframes and can break if you block framing globally.
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  client_max_body_size 2m;

  ###---[BLOCK DOTFILES]----------------------------------------------------------------------------
  location ~ /\.(?!well-known) {
    return 404;
  }

  ###---[ADMIN -> AUTHCONSOLE REDIRECT]-------------------------------------------------------------
  location = /admin {
    return 308 https://authconsole.hss.local/admin/;
  }
  location ^~ /admin/ {
    return 308 https://authconsole.hss.local$request_uri;
  }

  ###---[Health (no upstream)]----------------------------------------------------------------------
  location = /health {
    default_type application/json;
    add_header Content-Type application/json always;
    return 200 '{"status":"ok","service":"nginx","site":"auth.hss.local"}';
  }

  ###---[KEYCLOAK -> UPSTREAM]----------------------------------------------------------------------
  location / {
    proxy_pass http://keycloak_http;

    # Keycloak response headers (session cookies, OIDC redirects) can exceed default 4k/8k.
    # Without this: "upstream sent too big header" → 502 Bad Gateway.
    proxy_buffer_size          16k;
    proxy_buffers              4 16k;
    proxy_busy_buffers_size    24k;

    proxy_redirect off;

    # ---[FORWARDED HEADERS | REQUIRED FOR CORRECT URL/HOST SEMANTICS]------------------------------
    proxy_set_header Host              $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  443;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP         $remote_addr;

    # keep-alive stability (Keycloak is not websocket here)
    proxy_set_header Connection "";
  }
}

#===[AUTH CONSOLE HTTPS (KEYCLOAK ADMIN: authconsole.hss.local)]===================================
server {
  listen 443 ssl;
  http2 on;

  server_name authconsole.hss.local;

  ssl_certificate     /etc/nginx/certs/hss.local.pem;
  ssl_certificate_key /etc/nginx/certs/hss.local-key.pem;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;
  ssl_session_tickets off;

  # ---[SECURITY HEADERS | AUTH CONSOLE]-----------------------------------------------------------
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  client_max_body_size 2m;

  ###---[BLOCK DOTFILES]----------------------------------------------------------------------------
  location ~ /\.(?!well-known) {
    return 404;
  }

  ###---[OPTIONAL IP RESTRICTION | ADMIN ONLY]------------------------------------------------------
  # DEV TIP: enable once everything works (otherwise you’ll lock yourself out)
  # allow 127.0.0.1;
  # allow ::1;
  # allow 172.16.0.0/12;      # docker gateways/subnets
  # allow 192.168.0.0/16;     # home/office LAN (optional)
  # allow 10.0.0.0/8;         # corp/VPN (optional)
  # deny all;

  ###---[Health (no upstream)]----------------------------------------------------------------------
  location = /health {
    default_type application/json;
    add_header Content-Type application/json always;
    return 200 '{"status":"ok","service":"nginx","site":"authconsole.hss.local"}';
  }

  ###---[KEYCLOAK ADMIN CONSOLE -> UPSTREAM]--------------------------------------------------------
  location / {
    proxy_pass http://keycloak_http;

    # Keycloak response headers (session cookies, OIDC redirects) can exceed default 4k/8k.
    # Without this: "upstream sent too big header" → 502 Bad Gateway.
    proxy_buffer_size          16k;
    proxy_buffers              4 16k;
    proxy_busy_buffers_size    24k;

    proxy_redirect off;

    # ---[FORWARDED HEADERS | REQUIRED FOR CORRECT URL/HOST SEMANTICS]------------------------------
    proxy_set_header Host              $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  443;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP         $remote_addr;

    # Admin console can use websockets in some setups; safe defaults
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }
}

#===[MINIO S3 HTTPS (s3.hss.local)]=================================================================
server {
  listen 443 ssl;
  http2 on;

  server_name s3.hss.local;

  ssl_certificate     /etc/nginx/certs/hss.local.pem;
  ssl_certificate_key /etc/nginx/certs/hss.local-key.pem;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;
  ssl_session_tickets off;

  # ---[SECURITY HEADERS | S3]----------------------------------------------------------------------
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  client_max_body_size 0;

  ###---[BLOCK DOTFILES]----------------------------------------------------------------------------
  location ~ /\.(?!well-known) {
    return 404;
  }

  ###---[Health (no upstream)]----------------------------------------------------------------------
  location = /health {
    default_type application/json;
    add_header Content-Type application/json always;
    return 200 '{"status":"ok","service":"nginx","site":"s3.hss.local"}';
  }

  ###---[S3 -> MINIO API]---------------------------------------------------------------------------
  location / {
    proxy_pass http://minio_api;

    # ---[FORWARDED HEADERS | REQUIRED FOR CORRECT URL/HOST SEMANTICS]------------------------------
    proxy_set_header Host              $http_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  $server_port;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;

    # ---[S3 IS NOT WEBSOCKET]----------------------------------------------------------------------
    # keep-alive + signature stability; avoid forcing Upgrade/Connection upgrade
    proxy_set_header Connection "";

    chunked_transfer_encoding off;
    proxy_redirect off;
  }
}


#===[MINIO CONSOLE HTTPS (s3console.hss.local)]=====================================================
server {
  listen 443 ssl;
  http2 on;

  server_name s3console.hss.local;

  ssl_certificate     /etc/nginx/certs/hss.local.pem;
  ssl_certificate_key /etc/nginx/certs/hss.local-key.pem;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;
  ssl_session_tickets off;

  # ---[SECURITY HEADERS | CONSOLE]-----------------------------------------------------------------
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  client_max_body_size 0;

  ###---[BLOCK DOTFILES]----------------------------------------------------------------------------
  location ~ /\.(?!well-known) {
    return 404;
  }

  ###---[Health (no upstream)]----------------------------------------------------------------------
  location = /health {
    default_type application/json;
    add_header Content-Type application/json always;
    return 200 '{"status":"ok","service":"nginx","site":"s3console.hss.local"}';
  }

  ###---[CONSOLE -> MINIO CONSOLE]------------------------------------------------------------------
  location / {
    proxy_pass http://minio_console;

    # ---[FORWARDED HEADERS | CRITICAL FOR WSS + API TARGETS]---------------------------------------
    proxy_set_header Host              $http_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  $server_port;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;

    # ---[WEBSOCKET | OBJECT BROWSER]---------------------------------------------------------------
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    chunked_transfer_encoding off;
    proxy_redirect off;
  }
}
# EOF
