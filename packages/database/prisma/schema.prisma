// @file: packages/database/prisma/schema.prisma
generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ROOT
  SYSTEM
  ADMIN
  COMMISSION_CHAIR
  COMMISSION_SECRETARY
  COMMISSION_MEMBER
  SCOUT
  USER
  NONE
}

enum Gender {
  NONE
  MALE
  FEMALE
}

enum ScoutRank {
  NONE
  YOUNG // młodzik / ochotniczka
  PATHFINDER // wywiadowca / tropicielka
  DISCOVERER // odkrywca / pionierka
  TROOPER // ćwik / samarytanka
  EAGLE // Harcerz Orli / Harcerka Orla
  REPUBLIC // Harcerz Rzeczypospolitej / Harcerka Rzeczypospolitej
}

enum InstructorRank {
  GUIDE // PRZEWODNIK
  OPEN_SUBSCOUTMASTER // OTWARTY_PODHARCMISTRZ
  SUBSCOUTMASTER // PODHARCMISTRZ
  SCOUTMASTER // HARCMISTRZ
}

enum AllRank {
  NONE
  YOUNG
  PATHFINDER
  DISCOVERER
  TROOPER
  EAGLE
  REPUBLIC
  GUIDE
  OPEN_SUBSCOUTMASTER
  SUBSCOUTMASTER
  SCOUTMASTER
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  APPROVED
  REJECTED
  WITHDRAWN
}

enum UnitType {
  CHORAGIEW // Chorągiew
  HUFIEC // Hufiec
  DRUZYNA // Drużyna
}

enum Status {
  ACTIVE
  INACTIVE
  ARCHIVED
  PENDING_DELETION
}

enum AttachmentStatus {
  UPLOADING
  READY
  FAILED
  DELETED
}

enum MeetingSlotKind {
  DAY
  SLOT
}

enum MeetingSignupStatus {
  REQUESTED // user się zgłosił (dzień/slot)
  CONFIRMED // potwierdzone (slot zajęty albo przydzielono godzinę)
  REJECTED
  CANCELLED
}

model User {
  id                  String          @id @default(uuid()) @db.Uuid
  keycloakUuid        String          @unique @db.Uuid
  scoutUnitId         String?         @db.Uuid
  role                UserRole        @default(USER)
  email               String          @unique
  status              Status          @default(ACTIVE)
  // Personal data
  lastName            String?
  firstName           String?
  secondName          String?
  thirdName           String?
  phone               String?
  birthDate           DateTime?
  gender              Gender          @default(NONE)
  // Funcions
  teamFunction        String? // funkcja w drużynie
  groupFunction       String? // funkcja w hufcu / chorągwi
  // Scout data
  scoutRank           ScoutRank       @default(NONE)
  scoutStartDate      DateTime?
  // Timestamps
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  // Relations
  submissions         Submission[]
  comments            Comment[]
  unit                ScoutUnit?      @relation("UnitToParticipants", fields: [scoutUnitId], references: [id])
  meetingSlotsCreated MeetingSlot[]   @relation("MeetingSlotCreatedBy")
  meetingSignups      MeetingSignup[] @relation("MeetingSignupUser")
  meetingAssigned     MeetingSignup[] @relation("MeetingSignupAssignedBy")
}

model ScoutUnit {
  id           String        @id @default(uuid()) @db.Uuid
  parentUnitId String?       @db.Uuid
  // Scout unit data
  code         String
  name         String
  description  String?
  type         UnitType
  status       Status        @default(ACTIVE)
  // Timestamps
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  // Relations
  parentUnit   ScoutUnit?    @relation("UnitToParent", fields: [parentUnitId], references: [id])
  childUnits   ScoutUnit[]   @relation("UnitToParent")
  participants User[]        @relation("UnitToParticipants")
  meetingSlots MeetingSlot[]
}

model Submission {
  id                   String                            @id @default(uuid()) @db.Uuid
  userId               String                            @db.Uuid
  badgeId              String                            @db.Uuid
  // Submission data
  submissionStatus     SubmissionStatus                  @default(DRAFT)
  version              Int                               @default(1)
  status               Status                            @default(ACTIVE)
  // Personal data
  email                String                            @unique
  lastName             String
  firstName            String
  secondName           String?
  thirdName            String?
  phone                String
  birthDate            DateTime
  // Supervisor data
  supervisorLastName   String
  supervisorFirstName  String
  supervisorSecondName String?
  supervisorPhone      String
  supervisorRank       InstructorRank
  supervisionFunction  String
  // Timestamps
  createdAt            DateTime                          @default(now())
  updatedAt            DateTime                          @updatedAt
  // Relations
  user                 User                              @relation(fields: [userId], references: [id])
  badge                ProficiencyBadge                  @relation(fields: [badgeId], references: [id])
  comments             Comment[]
  fields               SubmissionProficiencyBadgeField[]
  attachments          Attachment[]
}

model ProficiencyBadge {
  id          String  @id @default(uuid()) @db.Uuid
  // Badge data
  code        String
  name        String
  description String?
  targetRank  AllRank @default(NONE)
  version     Int     @default(1)
  status      Status  @default(ACTIVE)

  // Timestamps
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  // Relations
  fields      ProficiencyBadgeField[]
  submissions Submission[]
}

model ProficiencyBadgeField {
  id                               String                            @id @default(uuid()) @db.Uuid
  badgeId                          String                            @db.Uuid
  parentFieldId                    String?                           @db.Uuid
  // Field data
  code                             String?
  name                             String?
  description                      String?
  hint                             String?
  version                          Int                               @default(1)
  status                           Status                            @default(ACTIVE)
  // Timestamps
  createdAt                        DateTime                          @default(now())
  updatedAt                        DateTime                          @updatedAt
  // Relations
  badge                            ProficiencyBadge                  @relation(fields: [badgeId], references: [id])
  parentField                      ProficiencyBadgeField?            @relation("FieldToParent", fields: [parentFieldId], references: [id])
  childFields                      ProficiencyBadgeField[]           @relation("FieldToParent")
  submissionProficiencyBadgeFields SubmissionProficiencyBadgeField[]
}

model SubmissionProficiencyBadgeField {
  id           String                @id @default(uuid()) @db.Uuid
  submissionId String                @db.Uuid
  fieldId      String                @db.Uuid
  // Field data
  isCompleted  Boolean               @default(false)
  description  String?
  comment      String?
  // Timestamps
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  // Relations
  submission   Submission            @relation(fields: [submissionId], references: [id])
  field        ProficiencyBadgeField @relation(fields: [fieldId], references: [id])
  comments     Comment[]
  attachments  Attachment[]
}

model Comment {
  id                String                           @id @default(uuid()) @db.Uuid
  authorId          String                           @db.Uuid
  submissionId      String?                          @db.Uuid
  submissionFieldId String?                          @db.Uuid
  // Comment data
  content           String
  // Timestamps
  createdAt         DateTime                         @default(now())
  updatedAt         DateTime                         @updatedAt
  // Relations
  author            User                             @relation(fields: [authorId], references: [id])
  submission        Submission?                      @relation(fields: [submissionId], references: [id])
  submissionField   SubmissionProficiencyBadgeField? @relation(fields: [submissionFieldId], references: [id])
}

model Attachment {
  id                String                           @id @default(uuid()) @db.Uuid
  // ownership (jedno z dwóch)
  submissionId      String?                          @db.Uuid
  submissionFieldId String?                          @db.Uuid
  // MinIO
  bucket            String
  objectKey         String                           @unique
  // meta
  originalName      String
  mimeType          String
  sizeBytes         BigInt
  status            AttachmentStatus                 @default(UPLOADING)
  // Timestamps
  createdAt         DateTime                         @default(now())
  updatedAt         DateTime                         @updatedAt
  // Relations
  submission        Submission?                      @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  submissionField   SubmissionProficiencyBadgeField? @relation(fields: [submissionFieldId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([submissionFieldId])
}

model MeetingSlot {
  id String @id @default(uuid()) @db.Uuid

  batchId String @db.Uuid

  unitId      String? @db.Uuid
  createdById String  @db.Uuid

  title       String
  description String?
  kind        MeetingSlotKind
  timezone    String          @default("Europe/Warsaw")

  startsAt DateTime @db.Timestamptz(3)
  endsAt   DateTime @db.Timestamptz(3)

  capacity Int    @default(1)
  status   Status @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  unit      ScoutUnit? @relation(fields: [unitId], references: [id])
  createdBy User       @relation("MeetingSlotCreatedBy", fields: [createdById], references: [id])

  signups MeetingSignup[]

  @@index([batchId])
  @@index([unitId])
  @@index([startsAt])
}

model MeetingSignup {
  id     String @id @default(uuid()) @db.Uuid
  slotId String @db.Uuid
  userId String @db.Uuid

  status MeetingSignupStatus @default(REQUESTED)
  note   String?

  // używane tylko gdy slot.kind=DAY (admin przypisuje godzinę)
  assignedStartsAt DateTime? @db.Timestamptz(3)
  assignedEndsAt   DateTime? @db.Timestamptz(3)
  assignedById     String?   @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  slot       MeetingSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  user       User        @relation("MeetingSignupUser", fields: [userId], references: [id], onDelete: Cascade)
  assignedBy User?       @relation("MeetingSignupAssignedBy", fields: [assignedById], references: [id])

  @@unique([slotId, userId])
  @@index([slotId])
  @@index([userId])
}
